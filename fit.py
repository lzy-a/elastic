import numpy as np
from scipy.optimize import nnls
import matplotlib.pyplot as plt

# 您提供的数据（示例数据，请替换为您的实际数据）
batch_sizes = np.array([64, 128, 256, 512, 1024, 4096, 8192, 16384, 32768, 65536])
data_time = np.array([0.0004872754626803928, 0.0007830895317925348, 0.001452011295273916, 0.002707496907638474, 0.005559433696977532, 0.025432062149047852, 0.052063547240363224, 0.10653213395012749, 0.18428711537961606, 0.2887822124693129])
forward_time = np.array([0.001521140988667806, 0.0015185254838731555, 0.001536131328329534, 0.0015552901074300822, 0.0015602376725938586, 0.0016234119733174641, 0.001731962627834744, 0.001873620351155599, 0.0019423520123517072, 0.001955827077229818])
loss_time = np.array([0.00265152710808648, 0.0026409353468153213, 0.0026286570027994273, 0.0026387974292946806, 0.0026626207992832703, 0.005249226093292236, 0.005476519796583388, 0.005729998482598198, 0.006769860232317889, 0.01048466894361708])
optimizer_time = np.array([0.002744463751051161, 0.0027477397070990667, 0.002752767118698407, 0.0027518242028108826, 0.0027536842893447554, 0.002768852975633409, 0.002795320087009006, 0.006654744678073459, 0.012456611350730614, 0.01819234424167209])
step_time = np.array([0.007473639043172201, 0.007761578326755099, 0.008445500988972116, 0.009736940359613698, 0.012620897400395948, 0.035166088740030924, 0.06216595967610677, 0.1209075927734375, 0.2055911929519088, 0.31954730881585014])

# 计算 Throughput
throughput = batch_sizes / step_time

# 构建设计矩阵 X1 (Forward Time)
X1 = np.vstack([batch_sizes, np.ones_like(batch_sizes)]).T

# 使用 NNLS 求解权重向量 W1
W1, _ = nnls(X1, throughput)

# 生成拟合曲线1
fit_curve1 = X1 @ W1

# 构建设计矩阵 X2 (Step Time)
X2 = np.vstack([batch_sizes, np.ones_like(batch_sizes)]).T

# 使用 NNLS 求解权重向量 W2
W2, _ = nnls(X2, step_time)

# 生成拟合曲线2
fit_curve2 = X2 @ W2


# 绘制拟合曲线2
plt.scatter(batch_sizes, step_time, label='Actual Step Time')
plt.plot(batch_sizes, fit_curve2, label='NNLS Fit Step Time', color='green')
plt.xlabel('Batch Size')
plt.ylabel('Step Time')
plt.legend()

plt.tight_layout()
plt.show()

# 打印拟合得到的权重向量
print("Weight Vector for Forward Time (W1):", W1)
print("Weight Vector for Step Time (W2):", W2)